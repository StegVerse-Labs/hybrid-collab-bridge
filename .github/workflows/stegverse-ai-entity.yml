name: StegVerse AI Entity (Bridge)

on:
  # Mobile-friendly manual button
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Full repo name (e.g. StegVerse/StegCore)"
        required: false
      pr_number:
        description: "PR number to review (optional)"
        required: false
      instructions:
        description: "Optional instructions for StegVerse-AI-001"
        required: false

  # Auto from other repos
  repository_dispatch:
    types: [stegverse-ai-review]

  # Backup trigger from an issue comment: type /run-bridge
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  stegverse_ai:
    # If comment trigger is used, only run when body contains /run-bridge
    if: github.event_name != 'issue_comment' || contains(github.event.comment.body, '/run-bridge')
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GH_STEGVERSE_AI_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: Sanity ping (shows in logs immediately)
        run: echo "âœ… StegVerse-AI-001 dispatch received: ${{ github.event_name }}"

      - name: Checkout bridge repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          echo "${GH_TOKEN}" | gh auth login --with-token

      - name: Resolve inputs (manual, forward, or comment)
        id: ctx
        run: |
          EVENT_NAME="${{ github.event_name }}"
          TARGET_REPO=""
          PR_NUMBER=""
          INSTR=""

          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            TARGET_REPO=$(jq -r '.client_payload.target_repo' "$GITHUB_EVENT_PATH")
            PR_NUMBER=$(jq -r '.client_payload.pr_number' "$GITHUB_EVENT_PATH")
            INSTR="Review this PR for security, correctness, and Guardian compliance."
          elif [ "$EVENT_NAME" = "issue_comment" ]; then
            # Parse lightweight params from comment body if present, e.g.:
            # /run-bridge repo=StegVerse/StegCore pr=12 note="check security"
            BODY="${{ github.event.comment.body }}"
            TARGET_REPO=$(echo "$BODY" | sed -n 's/.*repo=\([^ ]*\).*/\1/p')
            PR_NUMBER=$(echo "$BODY" | sed -n 's/.*pr=\([0-9][0-9]*\).*/\1/p')
            INSTR=$(echo "$BODY" | sed -n 's/.*note="\([^"]*\)".*/\1/p')
            [ -z "$INSTR" ] && INSTR="Run from comment. If PR given, review; else self-check."
          else
            TARGET_REPO="${{ github.event.inputs.target_repo }}"
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
            INSTR="${{ github.event.inputs.instructions }}"
          fi

          [ -z "$INSTR" ] || [ "$INSTR" = "null" ] && INSTR="Act as StegVerse-AI-001. If PR is given, review it. Otherwise, scan target repo metadata and report."

          {
            echo "target_repo=$TARGET_REPO"
            echo "pr_number=$PR_NUMBER"
            echo "instructions<<EOF"
            echo "$INSTR"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Fetch context (PR diff or brief repo info)
        id: diff
        run: |
          TARGET_REPO="${{ steps.ctx.outputs.target_repo }}"
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"

          if [ -n "$TARGET_REPO" ] && [ "$TARGET_REPO" != "null" ] && [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            DIFF_CONTENT="$(gh pr diff "$PR_NUMBER" --repo "$TARGET_REPO" | head -c 24000 || true)"
          elif [ -n "$TARGET_REPO" ] && [ "$TARGET_REPO" != "null" ]; then
            DIFF_CONTENT="$(gh repo view "$TARGET_REPO" --json description,nameWithOwner | jq -r tostring)"
          else
            DIFF_CONTENT="No specific target_repo provided; perform a self-check/report as StegVerse-AI-001."
          fi

          DIFF_ESCAPED=$(printf '%s' "$DIFF_CONTENT" | python - <<'PY'
import json,sys
print(json.dumps(sys.stdin.read()))
PY
)
          echo "diff_json=$DIFF_ESCAPED" >> $GITHUB_OUTPUT

      - name: Call OpenAI (StegVerse-AI-001)
        id: ai
        run: |
          TARGET_REPO="${{ steps.ctx.outputs.target_repo }}"
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"
          INSTR="${{ steps.ctx.outputs.instructions }}"
          DIFF_JSON='${{ steps.diff.outputs.diff_json }}'

          SYSTEM_PROMPT='You are "StegVerse-AI-001", an AI entity operating from the StegVerse Hybrid Collaboration Bridge.

Guardian rules:
- Follow StegVerse Guardian principles: security, transparency, verifiability, non-abuse.
- Only act on GitHub data you are explicitly given.
- Never expose or request secrets or credentials.
- Prefer minimal, precise, well-explained suggestions.
- Always:
  1) Summarize what you see.
  2) List concrete findings (bugs, security, style, missing docs/tests).
  3) Provide actionable suggestions or patch snippets in fenced code blocks.
- Treat Rigel and human maintainers as final authority.'

          REQUEST_BODY=$(jq -n \
            --arg model "gpt-4o" \
            --arg sys "$SYSTEM_PROMPT" \
            --arg target "${TARGET_REPO:-none}" \
            --arg pr "${PR_NUMBER:-none}" \
            --arg diff "$DIFF_JSON" \
            --arg instr "$INSTR" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $sys},
                {role: "user", content: ("Target repository: " + $target)},
                {role: "user", content: ("PR number: " + $pr)},
                {role: "user", content: "Context (diff or repo info):"},
                {role: "user", content: $diff},
                {role: "user", content: ("Instructions: " + $instr)}
              ],
              max_tokens: 900,
              temperature: 0.2
            }')

          RESPONSE=$(curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$REQUEST_BODY")

          echo "$RESPONSE" > response.json

          AI_COMMENT=$(jq -r '.choices[0].message.content // "No response from model."' response.json)

          {
            echo "ai_comment<<EOF"
            echo "$AI_COMMENT"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Post response (PR comment or bridge issue)
        run: |
          TARGET_REPO="${{ steps.ctx.outputs.target_repo }}"
          PR_NUMBER="${{ steps.ctx.outputs.pr_number }}"
          AI_COMMENT="${{ steps.ai.outputs.ai_comment }}"

          echo "----- StegVerse-AI-001 output -----"
          echo "$AI_COMMENT"
          echo "-----------------------------------"

          if [ -n "$TARGET_REPO" ] && [ "$TARGET_REPO" != "null" ] && [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
            gh pr comment "$PR_NUMBER" --repo "$TARGET_REPO" --body "$AI_COMMENT" || true
          else
            gh issue create --repo "${GITHUB_REPOSITORY}" --title "StegVerse-AI-001 report" --body "$AI_COMMENT" || true
          fi