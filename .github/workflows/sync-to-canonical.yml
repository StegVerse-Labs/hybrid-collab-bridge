name: sync-to-canonical

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 10 * * 1" # Mondays 10:00 UTC
  repository_dispatch:
    types: [sync-to-canonical]

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest

    env:
      CANONICAL_REPO: "StegVerse-Labs/StegDB"
      CANONICAL_ZIP_URL: "https://github.com/StegVerse-Labs/StegDB/releases/latest/download/canonical-bundle.zip"
      CANONICAL_SHA_URL: "https://github.com/StegVerse-Labs/StegDB/releases/latest/download/canonical-bundle.sha256"

      # Allowlist: only these paths are copied from canonical into this repo.
      SYNC_PATHS: |
        .github/workflows
        policy
        schema
        docs
        roles_templates
        tools

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download canonical bundle + sha
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL "$CANONICAL_ZIP_URL" -o /tmp/canonical-bundle.zip
          curl -fsSL "$CANONICAL_SHA_URL" -o /tmp/canonical-bundle.sha256
          (cd /tmp && sha256sum -c canonical-bundle.sha256)

      - name: Unpack canonical bundle
        shell: bash
        run: |
          set -euo pipefail
          rm -rf /tmp/canonical
          mkdir -p /tmp/canonical
          unzip -q /tmp/canonical-bundle.zip -d /tmp/canonical
          test -d /tmp/canonical/canonical || (echo "::error::Expected /canonical folder in bundle"; exit 2)

      - name: Write canonical lock file
        shell: bash
        run: |
          set -euo pipefail
          SHA="$(awk '{print $1}' /tmp/canonical-bundle.sha256)"
          python - <<PY
          import json, time
          lock = {
            "canonical_source": "${CANONICAL_REPO}",
            "canonical_zip": "${CANONICAL_ZIP_URL}",
            "canonical_sha_url": "${CANONICAL_SHA_URL}",
            "sha256": "${SHA}",
            "synced_at_utc": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
          }
          with open("stegverse.canonical.lock.json","w",encoding="utf-8") as f:
            json.dump(lock, f, indent=2, sort_keys=True)
            f.write("\n")
          print("Wrote stegverse.canonical.lock.json")
          PY

      - name: Sync allowlisted paths from canonical into repo (no deletions)
        shell: bash
        run: |
          set -euo pipefail
          while IFS= read -r p; do
            p="$(echo "$p" | xargs)"  # trim
            [[ -z "$p" ]] && continue
            src="/tmp/canonical/canonical/$p"
            dst="$p"

            if [[ -d "$src" ]]; then
              mkdir -p "$dst"
              rsync -a "$src/" "$dst/"
              echo "Synced dir: $p"
            elif [[ -f "$src" ]]; then
              mkdir -p "$(dirname "$dst")"
              rsync -a "$src" "$dst"
              echo "Synced file: $p"
            else
              echo "::notice title=Path not in canonical bundle::Skipping $p (not found)"
            fi
          done <<< "${SYNC_PATHS}"

      - name: Stamp workflow headers with canonical sha
        shell: bash
        run: |
          set -euo pipefail

          # Prefer canonical script if it exists (synced via tools/)
          if [[ -f "tools/stamp_workflow_headers.py" ]]; then
            python tools/stamp_workflow_headers.py
            exit 0
          fi

          echo "::warning::tools/stamp_workflow_headers.py not found; skipping header stamp."

      - name: Create PR if changes exist
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes after sync. Done."
            exit 0
          fi

          BR="canonical-sync-$(date -u +%Y%m%d%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BR"
          git add -A
          git commit -m "chore: sync to StegDB canonical bundle"
          git push -u origin "$BR"

          TITLE="chore: sync to canonical"
          BODY=$'This PR was generated by sync-to-canonical.\n\n- Source: '"${CANONICAL_REPO}"$'\n- Lock: `stegverse.canonical.lock.json`\n\nMerge to apply canonical updates.'
          gh pr create --title "$TITLE" --body "$BODY" || {
            echo "::warning::PR may already exist or permissions blocked. Create it manually from branch $BR."
          }
